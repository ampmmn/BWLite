# Soyokaze

## アプリケーションまわり

![](image/applicaiton.svg)

`Soyokaze`はMFCのダイアログベースアプリケーション

入力欄のダイアログ(CSoyokazeDlg)がアプリケーションのメインウインドウとしての位置づけ

入力欄でコマンド実行したり、非表示にしたりしても、ダイアログとしてはクローズすることはなく、単に非表示にしているだけ。

`exit`コマンドなどでアプリケーションを明示的に終了しない限り、
`DoModal()`呼び出しから戻らず、とどまり続ける。

## CSoyokazeApp

- 多重起動チェックはここで行っている


### 多重起動チェック

- `Global\\mutex_Soyokaze_exist`という名前のMutexの有無で判断する

- mutexをOpenできる場合は先行プロセスが存在する  
Openできない場合は初回起動

- 初回起動の場合は先行プロセスとしての起動処理を行う
- そうでなければ後続プロセスとしての起動処理を行う

#### 先行プロセスとしての起動処理

- InitFirstInstanceが該当する処理
  - 一般的なMFCアプリケーションのInitInstanceとしての処理をここで行う

- 初回起動の場合はミューテックスを作成し、起動している間、保持し続ける
   - CSoyokazeAppのメンバ変数`m_hMutexRun`でハンドルを保持する
   - デストラクタでCloseHandleする

- OpenMutexでハンドル取得できないにもかかわらず、CreateMutexに失敗する場合、同名のリソースオブジェクトを抱えている管理者権限で動作するプロセスがいる可能性があるので、その旨を表示してエラー終了する

- mutexをつくったら、ユーザーディレクトリもこのタイミングで作成している


#### 後続プロセスとしての起動処理

ToDo: 記載する

## ユーザディレレクトリの作成

ユーザディレクトリとは、`Soyokaze`が作成する一連の設定ファイルを保管するためのディレクトリ。

ユーザディレクトリの所在は下記

- 通常版の場合の場合 : $USERPROFILE/.soyokaze
- ポータブル版の場合 : `soyokaze.exe`のあるディレクトリ/profile

## 入力欄

CSoyokazeDlgクラスで実装している。
かなりの処理がここに置かれており、今のところ、このクラスが一番大きい


ToDo: 記載する


## タスクトレイ


## コマンド管理



